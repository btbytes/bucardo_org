<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="" xml:lang="en" lang="en" dir="ltr">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>{PageTitle}Bucardo</title>
		<style type="text/css" media="screen, projection">/*<![CDATA[*/
			@import "/css/common/shared.css";
			@import "/css/BucardoGreen/main-glossy.css";
		/*]]>*/</style>
		<link rel="stylesheet" type="text/css" media="print" href="?303" />
		<!--[if lt IE 7]><meta http-equiv="imagetoolbar" content="no" /><![endif]-->
	</head>
<body class="mediawiki  ltr ">
	<div id="globalWrapper">
		<div id="column-content">
	<div id="content">
		<a name="top" id="top"></a>
		<div id="bodyContent">
			<div id="contentSub"></div>
			<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<p>This page describes the steps needed to replicate a sample database, created by the pgbench utility, with Bucardo. This will demonstrate simply master to slave behavior, using the <a href="/pushdelta" title="wikilink">pushdelta</a> and <a href="/fullcopy" title="wikilink">fullcopy</a> sync types.</p>

<h2 id="install-bucardo">Install Bucardo</h2>

<p>The first step is to install Bucardo. Detailed instructions can be found on the <a href="/Bucardo/install" title="wikilink">installation page</a>, but the quick steps are:</p>

<h3 id="install-perl-modules">Install Perl modules</h3>

<p>Bucardo requires the following Perl modules to be installed:</p>

<ul>
  <li>DBD::Pg</li>
  <li>DBIx::Safe</li>
</ul>

<h3 id="download-and-unpack-bucardo">Download and unpack Bucardo</h3>

<p>The latest version of Bucardo can be found at <a href="/Bucardo/download" title="wikilink">the download page</a>. Alternatively, you can pull the development version from git by doing:</p>

<p><code class="highlighter-rouge"> git clone </code><a href="git://bucardo.org/bucardo.git"><code class="highlighter-rouge">git://bucardo.org/bucardo.git</code></a></p>

<p>Either way, you should end up in a bucardo directory, and ready for the next step.</p>

<h3 id="make-and-install">make and install</h3>

<p>Run the following commands:</p>

<p><code class="highlighter-rouge"> perl Makefile.PL</code>
<code class="highlighter-rouge"> make</code></p>

<p>The following step is optional but recommended:</p>

<p><code class="highlighter-rouge"> make test</code></p>

<p>Finally, install as a user with appropriate rights. One way to do this is:</p>

<p><code class="highlighter-rouge"> sudo make install</code></p>

<p>You should now have a global <a href="/bucardo_ctl" title="wikilink">bucardo_ctl</a> file available. Test that you can run it and that you are using the correct version:</p>

<p><code class="highlighter-rouge"> bucardo_ctl --version</code></p>

<h3 id="create-and-populate-the-database">Create and populate the database</h3>

<p>Bucardo needs a central database. The install option of bucardo_ctl will create and install this database for you. All you need to provide is the location of a Postgres instance you want to use, and a valid PID directory. For this example, we’ll use the default values of no host, port 5432, and a user named ‘Postgres’. We’ll use the <strong>/tmp/bucardo</strong> directory as our piddir value.</p>

<p><code class="highlighter-rouge"> mkdir /tmp/bucardo</code>
<code class="highlighter-rouge"> bucardo_ctl install --piddir=/tmp/bucardo</code></p>

<p>You will need to enter a “P” to tell it to proceed. If all goes well, you should see a message like this:</p>

<p><code class="highlighter-rouge">$ bucardo_ctl install --piddir=/tmp/bucardo</code>
<code class="highlighter-rouge">This will install the bucardo database into an existing Postgres cluster.</code>
<code class="highlighter-rouge">Postgres must have been compiled with Perl support,</code>
<code class="highlighter-rouge">and you must connect as a superuser</code>
<code class="highlighter-rouge">We will create a new superuser named 'bucardo',</code>
<code class="highlighter-rouge">and make it the owner of a new database named 'bucardo'</code>
<code class="highlighter-rouge">Current connection settings:</code>
<code class="highlighter-rouge">1. Host:          </code><none>
`2. Port:          5432`
`3. User:          postgres`
`4. PID directory: /tmp/bucardo`
`Enter a number to change it, P to proceed, or Q to quit: p`
`Postgres version is: 8.4`
`Attempting to create and populate the bucardo database and schema`
`Database creation is complete`
`Connecting to database 'bucardo' as user 'bucardo'`
`Updated configuration setting "piddir"`
`Installation is now complete.`
`If you see any unexpected errors above, please report them to bucardo-general@bucardo.org`
`You should probably check over the configuration variables next, by running:`
`bucardo_ctl show all`
`Change any setting by using: bucardo_ctl set foo=bar`</none></p>

<p>That’s it! Time to setup our test databases. NOTE: In this example the source/master and target/slave databases reside within a single instance of he Postgres server, and this installation step is normally only required for the source/master node. In the real world where source/master and target/slave are hosted in separate Postgres servers, each slave node will need to have the role ‘bucardo’ manually created before proceeding to the next step.</p>

<h2 id="setup-the-pgbench-databases">Setup the pgbench databases</h2>

<p>The <strong>pgbench</strong> utility that comes with Postgres can be used to create some simple test tables in an existing database. Let’s create two databases, test1 (the master), and test2 (the slave).</p>

<p><code class="highlighter-rouge"> createdb test1</code>
<code class="highlighter-rouge"> createdb test2</code></p>

<p>Next, we’ll install the pgbench files on each.</p>

<p><code class="highlighter-rouge"> pgbench -i test1</code>
<code class="highlighter-rouge"> pgbench -i test2</code></p>

<p>Now that we have some data, let’s get Bucardo to replicate it.</p>

<h2 id="add-the-databases">Add the databases</h2>

<p>Bucardo needs to know about each database it needs to talk to. The <a href="/bucardo_ctl" title="wikilink">bucardo_ctl</a> program does this with the <a href="/add_db" title="wikilink">add db</a> option.</p>

<p><code class="highlighter-rouge"> bucardo_ctl add db test1</code>
<code class="highlighter-rouge"> bucardo_ctl add db test2</code></p>

<p>We’ve kept it simple for this example, but you generally will end up replicating databases with the same name, and thus should add an extra internal database name. Since we did not provide one, they default to the actual database names.</p>

<h2 id="add-the-tables">Add the tables</h2>

<p>Bucardo also needs to know about any tables that it may be called on to replicate. Adding tables by the <a href="/add_table" title="wikilink">add table</a> command does not actually start replicating them. In this case, we’re going to use the handy <strong>add all tables</strong> feature. Tables are grouped together inside of Bucardo into <a href="/herd" title="wikilink">herds</a>, so we’ll also place the newly added tables into a named herd. Finally, the history table has no primary key or unique index, so we cannot replicate it by using the <a href="/pushdelta" title="wikilink">pushdelta</a> method, so we’re going to exclude it from the alpha herd, using the <a href="/-T" title="wikilink">-T</a> switch, and add it in the next setup with the <a href="/-t" title="wikilink">-t</a> switch.</p>

<p><code class="highlighter-rouge"> $ bucardo_ctl add all tables db=test1 -T history --herd=alpha --verbose</code>
<code class="highlighter-rouge"> New tables:</code>
<code class="highlighter-rouge">   public.accounts</code>
<code class="highlighter-rouge">   public.branches</code>
<code class="highlighter-rouge">   public.tellers</code>
<code class="highlighter-rouge"> New tables added: 3</code>
<code class="highlighter-rouge"> Already added: 0</code>
<code class="highlighter-rouge"> $ bucardo_ctl add all tables db=test1 -t history --herd=beta --verbose</code>
<code class="highlighter-rouge"> New tables:</code>
<code class="highlighter-rouge">   public.history</code>
<code class="highlighter-rouge"> New tables added: 1</code>
<code class="highlighter-rouge"> Already added: 0</code></p>

<h2 id="add-the-syncs">Add the syncs</h2>

<p>A <a href="/sync" title="wikilink">sync</a> is a named replication event. Each sync has a source herd; because we created two herds above, we’ll go ahead and create two syncs as well. One will be a <a href="/pushdelta" title="wikilink">pushdelta</a> sync, the other will be a <a href="/fullcopy" title="wikilink">fullcopy</a> sync.</p>

<p><code class="highlighter-rouge"> $ bucardo_ctl add sync benchdelta source=alpha targetdb=test2 type=pushdelta</code>
<code class="highlighter-rouge"> Added sync "benchdelta"</code></p>

<p><code class="highlighter-rouge"> $ bucardo_ctl add sync benchcopy source=beta targetdb=test2 type=fullcopy</code>
<code class="highlighter-rouge"> Added sync "benchcopy"</code></p>

<p>We are ready to kick off Bucardo at this point. Before we do, let’s use the <strong>list</strong> options to bucardo_ctl to check everything out.</p>

<p><code class="highlighter-rouge"> $ bucardo_ctl list herds</code>
<code class="highlighter-rouge"> Herd: alpha Members: public.branches, public.tellers, public.accounts</code>
<code class="highlighter-rouge">   Used in syncs: benchdelta</code>
<code class="highlighter-rouge"> Herd: beta  Members: public.history</code>
<code class="highlighter-rouge">   Used in syncs: benchcopy</code></p>

<p><code class="highlighter-rouge"> $ bucardo_ctl list syncs</code>
<code class="highlighter-rouge"> Sync: benchcopy   (fullcopy )  beta  =&gt;  test2  (Active)</code>
<code class="highlighter-rouge"> Sync: benchdelta  (pushdelta)  alpha =&gt;  test2  (Active)</code></p>

<p><code class="highlighter-rouge"> $ bucardo_ctl list dbs</code>
<code class="highlighter-rouge"> Database: test1  Status: active  Conn: psql -p 5432 -U bucardo -d test1</code>
<code class="highlighter-rouge"> Database: test2  Status: active  Conn: psql -p 5432 -U bucardo -d test2</code></p>

<p><code class="highlighter-rouge"> $ bucardo_ctl list tables</code>
<code class="highlighter-rouge"> Table: public.accounts  DB: test1  PK: aid (int4)</code>
<code class="highlighter-rouge"> Table: public.branches  DB: test1  PK: bid (int4)</code>
<code class="highlighter-rouge"> Table: public.history   DB: test1  PK: none</code>
<code class="highlighter-rouge"> Table: public.tellers   DB: test1  PK: tid (int4)</code></p>

<h2 id="start-bucardo">Start Bucardo</h2>

<p>The final step is to fire it up:</p>

<p><code class="highlighter-rouge"> bucardo_ctl start</code></p>

<p>After a few seconds, the prompt will return. There will be a log file in the current directory called <strong>log.bucardo</strong> that you can look through. To disable the logfile and just rely on syslog use the <a href="/--debugfile=0" title="wikilink">–debugfile=0</a> argument. You can also verify that the Bucardo daemons are running by doing a:</p>

<p><code class="highlighter-rouge"> ps -Afw | grep -i Bucardo</code></p>

<h2 id="test-replication">Test Replication</h2>

<p>To verify that things are working properly, let’s get some baseline counts:</p>

<p><code class="highlighter-rouge"> $ psql -d test1 -At -c 'select count(*) from tellers'</code>
<code class="highlighter-rouge"> 10</code></p>

<p><code class="highlighter-rouge"> $ psql -d test2 -At -c 'select count(*) from tellers'</code>
<code class="highlighter-rouge"> 10</code></p>

<p><code class="highlighter-rouge"> $ psql -d test1 -c 'select * from tellers where tid = 1'</code>
<code class="highlighter-rouge">  tid | bid | tbalance | filler </code>
<code class="highlighter-rouge"> -----+-----+----------+--------</code>
<code class="highlighter-rouge">    1 |   1 |        0 |</code>
<code class="highlighter-rouge"> (1 row)</code></p>

<p><code class="highlighter-rouge"> $ psql -d test2 -c 'select * from tellers where tid = 1'</code>
<code class="highlighter-rouge">  tid | bid | tbalance | filler</code>
<code class="highlighter-rouge"> -----+-----+----------+--------</code>
<code class="highlighter-rouge">    1 |   1 |        0 |</code>
<code class="highlighter-rouge"> (1 row)</code></p>

<p>Now let’s make changes to that record, and verify that it gets propagated to the slave (test2)</p>

<p><code class="highlighter-rouge"> $ psql -d test1 -c 'update tellers set bid=999 where tid = 1'</code>
<code class="highlighter-rouge"> UPDATE 1</code></p>

<p><code class="highlighter-rouge"> $ psql -d test2 -c 'select * from tellers where tid = 1'</code>
<code class="highlighter-rouge">  tid | bid | tbalance | filler</code>
<code class="highlighter-rouge"> -----+-----+----------+--------</code>
<code class="highlighter-rouge">    1 | 999 |        0 |</code></p>

<p>How about the history table, which has not primary key? We cannot track row by row changes, and don’t want to copy the whole thing every time the table changes, so we’ve got to <a href="/kick" title="wikilink">kick</a> that sync manually when we want to change it:</p>

<p><code class="highlighter-rouge"> $ psql -d -At test1 -c 'select count(*) from history'</code>
<code class="highlighter-rouge"> 0</code>
<code class="highlighter-rouge"> $ psql -d -At test2 -c 'select count(*) from history'</code>
<code class="highlighter-rouge"> 0</code></p>

<p><code class="highlighter-rouge"> $ pgbench -t3 test1</code></p>

<p><code class="highlighter-rouge"> $ psql -At -d test1 -c 'select count(*) from history'</code>
<code class="highlighter-rouge"> 3</code>
<code class="highlighter-rouge"> $ psql -At -d test2 -c 'select count(*) from history'</code>
<code class="highlighter-rouge"> 3</code></p>

<p><code class="highlighter-rouge"> $ bucardo_ctl kick benchcopy</code></p>

<p><code class="highlighter-rouge"> $ psql -At -d test1 -c 'select count(*) from history'</code>
<code class="highlighter-rouge"> 3</code>
<code class="highlighter-rouge"> $ psql -At -d test2 -c 'select count(*) from history'</code>
<code class="highlighter-rouge"> 3</code></p>

<p>This ends the demonstration. Feel free to play around more. To stop Bucardo when done, just issue:</p>

<p><code class="highlighter-rouge"> bucardo_ctl stop</code></p>

<p>As you experiment, you might also want to look at the syncs in more detail with:</p>

<p><code class="highlighter-rouge"> bucardo_ctl status</code>
<code class="highlighter-rouge"> bucardo_ctl status benchdelta</code>
<code class="highlighter-rouge"> bucardo_ctl status benchcopy</code></p>

<p><strong>NOTOC</strong> <a href="/Category:Bucardo" title="wikilink">Category:Bucardo</a></p>

</div>
			<div id='catlinks' class='catlinks catlinks-allhidden'></div>			<!-- end content -->
			<div class="visualClear"></div>
		</div>
	</div>
		</div>
		<div id="column-one">
	<div class="portlet" id="p-logo">
	<h2><a href="/"Array>bucardo.org</a></h2>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		</div><!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>
</div>
</body></html>
